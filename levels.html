<!DOCTYPE html>
<html lang="en" data-detail="0">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hole People - Level Guides</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary:#6C63FF;--primary-light:#8580FF;--accent:#36D1DC;
      --light-bg:#f8f9fe;--card-bg:#fff;--text-dark:#2d2b4e;--text-light:#5a5779;
      --border-light:#e4e6f0;--gradient-primary:linear-gradient(135deg,var(--primary),var(--accent));
      --shadow:0 10px 30px rgba(108,99,255,.15);--shadow-hover:0 15px 35px rgba(108,99,255,.25);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{padding-top:72px;background:var(--light-bg);font-family:'Poppins',sans-serif;color:var(--text-light);line-height:1.6;overflow-x:hidden}
    .container{width:90%;max-width:1200px;margin:0 auto}
    #levels-hero,#levels-tools,#levels-grid,#levels-ad,#levels-featured{padding:2rem 0}
    .section-title{font-family:'Oxanium',cursive;font-weight:700;color:var(--text-dark);font-size:2.2rem;text-align:center;margin:0 auto 2rem;position:relative}
    .section-title::after{content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:80px;height:4px;border-radius:2px;background:var(--gradient-primary)}
    .inject-error{padding:12px;border:1px dashed #f99;color:#b00;background:#fff}

    /* —— 详情页兜底样式（模板还有更完整的一套，会挂到 head） —— */
    .level-detail{padding:2rem 0;min-height:60vh}
    .level-detail .container{background:var(--card-bg);border-radius:12px;padding:2rem;box-shadow:var(--shadow);margin-top:1rem}
    .level-detail h1{font-family:'Oxanium',cursive;color:var(--primary);margin-bottom:1rem;font-size:2.2rem}
    .level-detail p{color:var(--text-light);font-size:1.06rem;line-height:1.6}
    .back-button{display:inline-flex;align-items:center;margin-bottom:1.2rem;color:var(--primary);text-decoration:none;font-weight:600}
    .back-button:hover{color:var(--accent)}
  </style>

  <script>
    // 判断是否“详情模式”
    (function () {
      const p = new URLSearchParams(location.search);
      const n = parseInt(p.get('n'), 10);
      const inDetail = Number.isInteger(n) && n >= 1 && n <= 570;
      document.documentElement.dataset.detail = inDetail ? '1' : '0';
      if (!inDetail) return;

      document.title = `Level ${n} · Hole People`;

      // 片段注入（header/footer）
      async function inject(id, url) {
        const host = document.getElementById(id);
        if (!host) return;
        try {
          const res = await fetch(url + '?v=' + Date.now(), { cache: 'no-store' });
          host.innerHTML = await res.text();
        } catch (e) {
          host.innerHTML = `<div class="inject-error">Failed to load ${url}: ${e.message}</div>`;
        }
      }

      // 挂载模板中的样式到 <head>
      function mountStylesFrom(html) {
        document.querySelectorAll('style[data-level-style],link[data-level-style]').forEach(el => el.remove());
        const box = document.createElement('div'); box.innerHTML = html;

        box.querySelectorAll('style').forEach(s=>{
          const t=document.createElement('style'); t.setAttribute('data-level-style','1'); t.textContent=s.textContent||''; document.head.appendChild(t);
        });
        box.querySelectorAll('link[rel="stylesheet"]').forEach(l=>{
          const t=document.createElement('link'); t.rel='stylesheet'; t.setAttribute('data-level-style','1');
          ['href','media','crossorigin','referrerpolicy','integrity'].forEach(a=>{ if(l.hasAttribute(a)) t.setAttribute(a,l.getAttribute(a));});
          document.head.appendChild(t);
        });
      }

      // 执行模板里的 <script>
      function runScriptsFrom(html){
        const box=document.createElement('div'); box.innerHTML=html;
        box.querySelectorAll('script').forEach(s=>{
          const t=document.createElement('script');
          if(s.src) t.src=s.src; else t.text=s.textContent||'';
          ['type','async','defer','crossorigin','referrerpolicy'].forEach(a=>{ if(s.hasAttribute(a)) t.setAttribute(a,s.getAttribute(a));});
          document.body.appendChild(t);
        });
      }

      // 把 /level.html?n=.. 改成 levels.html?n=..
      function rewriteLevelLinks(root){
        const sel=[
          'a[href^="/level.html?n="]','a[href^="level.html?n="]',
          'a[href^="/level?n="]','a[href^="level?n="]'
        ].join(',');
        root.querySelectorAll(sel).forEach(a=>{
          try{
            const u=new URL(a.getAttribute('href'),location.origin);
            const num=u.searchParams.get('n');
            if(num) a.setAttribute('href', `levels.html?n=${num}`);
          }catch{}
        });
      }

      document.addEventListener('DOMContentLoaded', async ()=>{
        // header 先注入
        await inject('header-container','/components/header.html');

        const mount = document.getElementById('detail-root');
        if(!mount) return;

        try{
          const r = await fetch('/components/level/[slug].html', { cache:'no-store' });
          let tpl = await r.text();
          tpl = tpl.replaceAll('{{ slug }}', String(n));

          // 样式挂头部
          mountStylesFrom(tpl);

          // 清理模板中可能重复的 header/footer 容器
          const box=document.createElement('div'); box.innerHTML=tpl;
          box.querySelectorAll('#header-container,#footer-container').forEach(el=>el.remove());

          // 把主体 section 放到挂载点
          const section = box.querySelector('.level-detail') || box.firstElementChild || box;
          mount.innerHTML=''; mount.appendChild(section);

          // 运行模板脚本（视频、推荐、prev/next 等）
          runScriptsFrom(tpl);

          // 改写链接（包含异步新增节点）
          rewriteLevelLinks(document);
          const mo=new MutationObserver(ms=>ms.forEach(m=>m.addedNodes && m.addedNodes.forEach(n=>{ if(n.nodeType===1) rewriteLevelLinks(n); })));
          mo.observe(document.body,{childList:true,subtree:true});
        }catch(e){
          mount.innerHTML = `<div class="inject-error">Failed to load level template: ${e.message}</div>`;
        }

        // footer
        await inject('footer-container','/components/footer.html');
      });
    })();
  </script>
</head>
<body>
  <!-- 头部挂载（两种模式共用） -->
  <div id="header-container"></div>

  <!-- 列表模式：由 main.js 注入 -->
  <div id="levels-hero"></div>
  <div id="levels-tools"></div>
  <div id="levels-grid"></div>
  <div id="levels-ad"></div>
  <div id="levels-featured"></div>

  <!-- 详情模式：挂载点 -->
  <main id="detail-root"></main>

  <!-- 页脚挂载（两种模式共用） -->
  <div id="footer-container"></div>

  <!-- 只有“列表模式”才加载 main.js；失败会给出提示 -->
  <script>
    (function(){
      if (document.documentElement.dataset.detail === '0') {
        var s = document.createElement('script');
        s.src = '/scripts/main.js?v=6';
        s.onerror = function(){
          var box = document.createElement('div');
          box.className = 'inject-error';
          box.style.margin='16px';
          box.innerHTML = 'Failed to load <code>/scripts/main.js</code>. Please hard-refresh (Cmd/Ctrl+Shift+R).';
          document.body.prepend(box);
        };
        document.body.appendChild(s);
      }
    })();
  </script>
</body>
</html>
